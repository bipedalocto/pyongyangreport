<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FVTT TTRPG 로그 HTML 변환기</title>
    <style>
        /* --- 페이지 전체 스타일 --- */
        :root {
            --bg-color: #1a1a1d;
            --primary-text-color: #f0f0f0;
            --secondary-text-color: #8c8c8e;
            --border-color: #434343;
            --container-bg: #2c2c2e;
            --button-bg: #4a4e69;
            --button-hover-bg: #6a6e99;
            --preview-border: #555;
            --system-message-bg: rgba(74, 78, 105, 0.2);
        }
        
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 25px;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        h1 {
            text-align: center;
            color: var(--primary-text-color);
            border-bottom: 2px solid var(--button-bg);
            padding-bottom: 10px;
            margin-top: 0;
        }

        p.instructions {
            text-align: center;
            color: var(--secondary-text-color);
            font-size: 0.9em;
        }
        
        textarea {
            width: 100%;
            height: 250px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            margin-bottom: 15px;
            resize: vertical;
        }

        .button-group {
            text-align: center;
            margin-bottom: 25px;
        }

        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--button-hover-bg);
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #preview-container {
            border: 2px dashed var(--preview-border);
            padding: 20px;
            min-height: 150px;
            border-radius: 5px;
            background-color: var(--bg-color);
        }
        
        /* --- 미리보기 & 결과물 HTML 스타일 --- */
        .log-body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            background-color: #1a1a1d;
            color: #f0f0f0;
            padding: 20px;
        }

        .log-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2c2c2e;
            padding: 20px;
            border-radius: 8px;
        }

        .message-block {
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid #434343;
            overflow: hidden; /* clearfix for floated timestamp */
        }
        
        .message-block:last-child {
            border-bottom: none;
        }

        .speaker {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .timestamp {
            float: right;
            color: #8c8c8e;
            font-size: 0.75em;
            text-align: right;
            line-height: 1.3;
        }

        .content {
            font-size: 0.95em;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-right: 140px; /* 타임스탬프와 겹치지 않도록 */
        }

        .system-message .content {
            font-style: italic;
            color: #a0a0c0;
            background-color: var(--system-message-bg);
            padding: 8px;
            border-radius: 4px;
        }

        /* 긴 메시지 접기/펼치기 스타일 */
        .collapsible {
            max-height: 70px; /* 기본적으로 보일 최대 높이 */
            overflow: hidden;
            position: relative;
            transition: max-height 0.4s ease-in-out;
        }

        .collapsible:hover {
            max-height: 1000px; /* 호버 시 펼쳐질 최대 높이 */
        }
        
        .collapsible::after {
            content: '... 더 보기';
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            text-align: center;
            font-weight: bold;
            font-size: 0.8em;
            color: #aaa;
            height: 25px;
            background: linear-gradient(transparent, #2c2c2e 80%);
            pointer-events: none; /* 클릭 이벤트가 부모로 전달되도록 */
            transition: opacity 0.2s;
        }
        
        .collapsible:hover::after {
            opacity: 0;
        }

    </style>
</head>
<body>

    <div class="main-container">
        <h1>📜 FVTT 로그 HTML 변환기</h1>
        <p class="instructions">아래 텍스트 영역에 Foundry VTT의 .txt 로그 파일 내용을 붙여넣으세요. <br> '미리보기 생성' 버튼으로 결과를 확인하고, 'HTML 파일로 다운로드' 버튼으로 저장할 수 있습니다.</p>

        <textarea id="logInput" placeholder="이곳에 로그 파일 내용을 붙여넣으세요."></textarea>
        
        <div class="button-group">
            <button onclick="generatePreview()">미리보기 생성</button>
            <button id="downloadBtn" onclick="downloadHtmlFile()" disabled>HTML 파일로 다운로드</button>
        </div>

        <div id="preview-container">
            <p style="text-align:center; color: var(--secondary-text-color);">미리보기 결과가 여기에 표시됩니다.</p>
        </div>
    </div>
    
    <script>
        // 예시 로그 데이터를 textarea에 미리 채워넣습니다.
        document.getElementById('logInput').value = `[9/1/2025, 8:09:49 PM] Gamemaster
{Game Time: Sep 01, 2085 00:02}
아! 오도짜세기합 넘치는 평양의 건아들이여!
---------------------------
[9/1/2025, 8:10:15 PM] Gamemaster
{Game Time: Sep 01, 2085 00:02}
는 아니고 아무튼 여러분은 평양에서 해결사, 그러니까 짬처리 전문용역으로서 살아가고 있어요.
---------------------------
[9/1/2025, 8:10:57 PM] Gamemaster
{Game Time: Sep 01, 2085 00:02}
먼저 리=일은 뭐 하는 년인가요?
---------------------------
[9/1/2025, 8:11:08 PM] 리 일
{Game Time: Sep 01, 2085 00:02}
리-일은 최근 유행하는 사이비에 심취한 애송이입니다
변화교라는 종교인데
자기 자신의 총체적이고도 연속적인 변화를
목표로 삼는 교리를 가지고 있어요
친구따라 전도받다 눈이 번쩍 뜨인 리 일은
아빠한테 받은 용돈을 다 털어서
기계팔 네 개를 이식받기로 결심합니다
그리고 하는김에 칼날도 같이 넣어서
다음 변화를 위한 재료값도 좀 벌기로 했어요
좀 있으면 경연이라는 행사가 평양에서 열리는데
변화교의 교류회라고 생각하면 됩니다
여기에서 존나 멋진 변화를 보여 줄 생각에
들떠있어요
이상!!
---------------------------
[9/1/2025, 8:13:35 PM] Gamemaster
{Game Time: Sep 01, 2085 00:02}
그러니까 세기말 프로사이버 신천지 열성신도라는 거군요?
---------------------------
[9/1/2025, 8:21:49 PM] Gamemaster
{Game Time: Sep 01, 2085 00:02}
각자의 시궁창에서 휴식을 취하던 도중 동네 힘센 픽서 자이치크의 단체 홀로콜 호출을 받습니다.
---------------------------
[9/2/2025, 12:00:11 AM] 밴스
{Game Time: Sep 01, 2085 00:02}
피토하며 다운
---------------------------
[9/2/2025, 12:05:02 AM] 리 일
{Game Time: Sep 01, 2085 00:02}
"시발 메딕!!"
`;

        const speakerColors = {};
        const colorPalette = [
            '#ff8989', '#89c3ff', '#a2ff89', '#ff89f5', '#ffda89', 
            '#89fff3', '#e8aaff', '#b4c8aa', '#ffb2a4', '#a4dff3'
        ];
        let colorIndex = 0;

        function getSpeakerColor(speaker) {
            // GM, NPC 이름 등 특정 이름에 고정 색상 부여
            const fixedColors = {
                'Gamemaster': '#e0e0e0',
                '자이치크': '#f5a623',
                '리커이': '#f8e71c',
                '깡패': '#ff7675',
                '야옹이': '#fdcb6e',
                'SM58': '#74b9ff',
            };
            if (fixedColors[speaker]) {
                return fixedColors[speaker];
            }
            // 플레이어 캐릭터들에게 순차적으로 색상 할당
            if (!speakerColors[speaker]) {
                speakerColors[speaker] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return speakerColors[speaker];
        }

        function parseLog(rawLog) {
            // 일관성을 위해 태그 제거
            const cleanLog = rawLog.replace(/\\s*/g, '');
            const messages = cleanLog.split(/\s*---------------------------\s*/);
            
            let htmlContent = '';
            
            messages.forEach(msg => {
                if (msg.trim() === '') return;

                const lines = msg.trim().split('\n');
                const firstLine = lines.shift();

                const timeMatch = firstLine.match(/^\[(.*?)\]/);
                const speaker = firstLine.replace(/^\[.*?\]\s*/, '').trim();
                
                let gameTime = '';
                let content = lines.join('\n').trim();

                if (lines[0] && lines[0].startsWith('{Game Time:')) {
                    gameTime = lines.shift().replace(/[{}]/g, '').trim();
                    content = lines.join('\n').trim();
                }
                
                const timestamp = timeMatch ? timeMatch[1] : 'N/A';
                
                // 시스템 메시지 (아이템 줍기 등) 판별
                const isSystemMessage = speaker.endsWith('picked up the following items:') || speaker.startsWith('#');
                const finalSpeaker = isSystemMessage ? 'System' : speaker;

                const color = getSpeakerColor(finalSpeaker);
                const isLong = content.split('\n').length > 4 || content.length > 250;
                
                htmlContent += `
                    <div class="message-block ${isSystemMessage ? 'system-message' : ''}">
                        <span class="timestamp">${timestamp}<br>${gameTime}</span>
                        <span class="speaker" style="color: ${color};">${finalSpeaker}</span>
                        <div class="content ${isLong ? 'collapsible' : ''}">${content}</div>
                    </div>
                `;
            });
            
            return htmlContent;
        }
        
        function generateFullHtml() {
            const rawLog = document.getElementById('logInput').value;
            // 새 로그 처리 시마다 색상 할당 초기화
            Object.keys(speakerColors).forEach(key => delete speakerColors[key]);
            colorIndex = 0;

            const bodyContent = parseLog(rawLog);
            const styleContent = document.querySelector('style').innerHTML;

            return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>TTRPG 로그</title>
    <style>
        ${styleContent}
    </style>
</head>
<body class="log-body">
    <div class="log-container">
        <h1 style="text-align:center; border-bottom: 2px solid #4a4e69; padding-bottom: 10px;">게임 로그</h1>
        ${bodyContent}
    </div>
</body>
</html>
            `;
        }

        function generatePreview() {
            const rawLog = document.getElementById('logInput').value;
             // 새 로그 처리 시마다 색상 할당 초기화
            Object.keys(speakerColors).forEach(key => delete speakerColors[key]);
            colorIndex = 0;

            const previewDiv = document.getElementById('preview-container');
            previewDiv.innerHTML = `<div class="log-container">${parseLog(rawLog)}</div>`;
            document.getElementById('downloadBtn').disabled = false;
        }

        function downloadHtmlFile() {
            const fullHtml = generateFullHtml();
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ttrpg_log.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

    </script>

</body>
</html>